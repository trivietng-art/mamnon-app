<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quáº£n LÃ½ & ÄÃ¡nh GiÃ¡ Há»c Sinh Máº«u GiÃ¡o</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">
  <style>
    :root{--primary:#4CAF50;--success:#10b981;--danger:#ef4444;--warning:#f59e0b}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;padding:16px;background:linear-gradient(135deg,#e8f5e9 0%,#ffffff 100%);min-height:100vh}
    .container{max-width:1600px;margin:0 auto;background:#fff;border-radius:16px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,0.08)}
    h1{color:var(--primary);margin:0 0 24px;font-size:28px;text-align:center}
    .top-section{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:24px}
    .card{background:#f8fafc;padding:16px;border-radius:12px;border:2px solid #e2e8f0}
    .card h2{margin:0 0 16px;font-size:18px;color:#334155}
    .form-group{margin-bottom:12px}
    label{display:block;margin-bottom:6px;font-weight:600;font-size:14px;color:#475569}
    input,select,textarea{width:100%;padding:10px;border:2px solid #cbd5e1;border-radius:8px;font-size:14px;box-sizing:border-box}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary)}
    textarea{resize:vertical;min-height:60px}
    .btn-group{display:flex;gap:8px;margin-top:12px}
    button{padding:10px 20px;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:14px;transition:all 0.2s}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover{background:#43a047;transform:translateY(-2px)}
    .btn-success{background:var(--success);color:#fff}
    .btn-success:hover{background:#059669}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-danger:hover{background:#dc2626}
    .btn-warning{background:var(--warning);color:#fff}
    .student-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-top:20px}
    .student-card{background:var(--success);padding:12px;border-radius:10px;border:2px solid #059669;cursor:pointer;transition:all 0.2s;position:relative;color:#fff}
    .student-card:hover{transform:translateY(-3px);box-shadow:0 8px 16px rgba(0,0,0,0.05)}
    .student-card.absent{background:var(--danger);border-color:#dc2626}
    .student-card.empty{border-style:dashed;background:#f9fafb;opacity:0.9;color:#64748b;border-color:#cbd5e1}
    .student-number{font-size:20px;font-weight:700;color:#fff;margin-bottom:4px}
    .student-name{font-size:14px;color:#fff;font-weight:500}
    .student-card.empty .student-number{color:#64748b}
    .student-card.empty .student-name{color:#64748b}
    .attendance-badge{position:absolute;top:8px;right:8px;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;background:rgba(255,255,255,0.3);font-weight:700}
    .rating-badge{background:var(--primary);color:#fff;padding:2px 8px;border-radius:12px;font-size:11px;margin-top:4px;display:inline-block;margin-right:4px}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:20px}
    .stat-card{background:linear-gradient(135deg,var(--primary) 0%,#2e7d32 100%);color:#fff;padding:16px;border-radius:12px;text-align:center}
    .stat-number{font-size:32px;font-weight:700;margin-bottom:4px}
    .stat-label{font-size:14px;opacity:0.9}
    .quick-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .quick-actions button{flex:1;min-width:120px}
    .rating-grid{display:grid;grid-template-columns:2fr 1fr;gap:8px;align-items:center;max-height:200px;overflow-y:auto;padding:4px}
    .rating-item{display:contents}
    .rating-label{font-size:12px;color:#334155;font-weight:500}
    .scale-info{background:#fef3c7;padding:8px 12px;border-radius:6px;font-size:12px;margin-bottom:12px;border-left:4px solid var(--warning)}
    .file-upload{border:2px dashed #cbd5e1;padding:20px;border-radius:8px;text-align:center;cursor:pointer;transition:all 0.2s}
    .file-upload:hover{border-color:var(--primary);background:#f8fafc}
    .file-upload input{display:none}
    .output-table{width:100%;border-collapse:collapse;font-size:12px;margin-top:12px}
    .output-table th,.output-table td{padding:8px;text-align:left;border:1px solid #e2e8f0}
    .output-table th{background:var(--primary);color:#fff;font-weight:600}
    .output-table tr:nth-child(even){background:#f8fafc}
    .output-table tr:hover{background:#eef2ff}
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¨ QUáº¢N LÃ & ÄÃNH GIÃ Há»ŒC SINH MáºªU GIÃO ğŸ¨</h1>

    <div class="top-section">
      <div class="card">
        <h2>ğŸ“… ThÃ´ng Tin NgÃ y Há»c</h2>
        <div class="form-group">
          <label>NgÃ y há»c</label>
          <input type="date" id="input-date" />
        </div>
        <div class="form-group">
          <label>Tá»•ng sá»‘ há»c sinh (1-60)</label>
          <input type="number" id="input-total" min="1" max="60" value="30" />
        </div>
        <button class="btn-primary" style="width:100%" onclick="updateTotalStudents()">Cáº­p nháº­t sá»‘ lÆ°á»£ng</button>

        <div style="margin-top:20px;padding-top:20px;border-top:2px solid #e2e8f0">
          <h2 style="font-size:16px;margin-bottom:12px">ğŸ“‚ Nháº­p tá»« File</h2>
          <div class="file-upload" onclick="document.getElementById('file-input').click()">
            <input type="file" id="file-input" accept=".txt" onchange="importFromFile(event)" />
            <div style="font-size:40px;margin-bottom:8px">ğŸ“„</div>
            <div style="font-weight:600;color:#334155">Click Ä‘á»ƒ chá»n file .txt</div>
            <div style="font-size:12px;color:#64748b;margin-top:4px">Nháº­p dá»¯ liá»‡u há»c sinh tá»« file</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>âœï¸ Nháº­p ThÃ´ng Tin CÆ¡ Báº£n</h2>
        <div class="form-group">
          <label>Sá»‘ thá»© tá»± (1-60)</label>
          <input type="number" id="input-number" min="1" max="60" value="1" />
        </div>
        <div class="form-group">
          <label>Há» vÃ  tÃªn há»c sinh</label>
          <input type="text" id="input-name" placeholder="VD: Nguyá»…n VÄƒn An" />
        </div>
        <div class="form-group">
          <label>Äiá»ƒm danh</label>
          <select id="input-attendance" onchange="updateAttendancePreview()">
            <option value="">-- Chá»n --</option>
            <option value="present">1 - CÃ³ máº·t (MÃ u xanh)</option>
            <option value="absent">2 - Váº¯ng (MÃ u Ä‘á»)</option>
          </select>
        </div>
        <div class="btn-group">
          <button class="btn-success" style="flex:1" onclick="saveBasicInfo()">ğŸ’¾ LÆ°u thÃ´ng tin</button>
          <button class="btn-danger" onclick="clearStudent()">ğŸ—‘ï¸ XÃ³a</button>
        </div>
        <div class="quick-actions">
          <button class="btn-primary" onclick="markAllPresent()">âœ… Táº¥t cáº£ cÃ³ máº·t</button>
          <button class="btn-danger" onclick="clearAllAttendance()">ğŸ”„ XÃ³a Ä‘iá»ƒm danh</button>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ“Š ÄÃ¡nh GiÃ¡ Chi Tiáº¿t</h2>
        <div class="form-group">
          <label>TÃ­nh cÃ¡ch</label>
          <textarea id="input-personality" placeholder="VD: Hiáº¿u Ä‘á»™ng, thÃ¢n thiá»‡n..."></textarea>
        </div>

        <div class="scale-info">
          <strong>ğŸ“ Thang Ä‘iá»ƒm:</strong> 1-10 (1: Yáº¿u â†’ 10: Xuáº¥t sáº¯c)
        </div>

        <div class="rating-grid">
          <div class="rating-label">1. Ká»¹ nÄƒng giao tiáº¿p</div>
          <input type="number" id="rating-1" min="1" max="10" value="5" />

          <div class="rating-label">2. Kháº£ nÄƒng há»c táº­p</div>
          <input type="number" id="rating-2" min="1" max="10" value="5" />

          <div class="rating-label">3. SÃ¡ng táº¡o</div>
          <input type="number" id="rating-3" min="1" max="10" value="5" />

          <div class="rating-label">4. Ká»· luáº­t</div>
          <input type="number" id="rating-4" min="1" max="10" value="5" />

          <div class="rating-label">5. TÆ°Æ¡ng tÃ¡c xÃ£ há»™i</div>
          <input type="number" id="rating-5" min="1" max="10" value="5" />

          <div class="rating-label">6. Váº­n Ä‘á»™ng</div>
          <input type="number" id="rating-6" min="1" max="10" value="5" />

          <div class="rating-label">7. Tá»± chÄƒm sÃ³c</div>
          <input type="number" id="rating-7" min="1" max="10" value="5" />

          <div class="rating-label">8. Cáº£m xÃºc</div>
          <input type="number" id="rating-8" min="1" max="10" value="5" />

          <div class="rating-label">9. Táº­p trung</div>
          <input type="number" id="rating-9" min="1" max="10" value="5" />

          <div class="rating-label">10. GiÃºp Ä‘á»¡ báº¡n</div>
          <input type="number" id="rating-10" min="1" max="10" value="5" />
        </div>

        <button class="btn-warning" style="width:100%;margin-top:12px" onclick="saveRatings()">â­ LÆ°u Ä‘Ã¡nh giÃ¡</button>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card" style="background:linear-gradient(135deg,#4CAF50 0%,#2e7d32 100%)">
        <div class="stat-number" id="stat-total">30</div>
        <div class="stat-label">ğŸ‘¥ Tá»•ng há»c sinh</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#10b981 0%,#059669 100%)">
        <div class="stat-number" id="stat-present">0</div>
        <div class="stat-label">âœ… CÃ³ máº·t</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%)">
        <div class="stat-number" id="stat-absent">0</div>
        <div class="stat-label">âŒ Váº¯ng máº·t</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%)">
        <div class="stat-number" id="stat-rated">0</div>
        <div class="stat-label">â­ ÄÃ£ Ä‘Ã¡nh giÃ¡</div>
      </div>
    </div>

    <div class="card" style="margin-top:20px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <h2>ğŸ“‹ Danh SÃ¡ch Há»c Sinh</h2>
        <div style="display:flex;gap:8px">
          <button class="btn-success" onclick="exportToFile()">ğŸ“¥ Xuáº¥t File TXT</button>
          <button class="btn-primary" onclick="exportToExcel('day')">ğŸ“¤ Xuáº¥t CSV (NgÃ y)</button>
          <button class="btn-primary" onclick="exportToExcel('week')">ğŸ“¤ Xuáº¥t CSV (Tuáº§n)</button>
          <button class="btn-primary" onclick="exportToExcel('month')">ğŸ“¤ Xuáº¥t CSV (ThÃ¡ng)</button>
        </div>
      </div>
      <div class="student-list" id="student-list"></div>
    </div>

    <div class="card" style="margin-top:20px">
      <h2>ğŸ“Š Báº£ng ÄÃ¡nh GiÃ¡ Chi Tiáº¿t</h2>
      <div style="overflow-x:auto">
        <div id="output-table"></div>
      </div>
    </div>
  </div>

  <script>
    // Persistence: load/save from localStorage
    const STORAGE_KEY = 'mamnon_app_v1';
    function saveToStorage() {
      const payload = {
        students,
        totalStudents,
        dailyData
      };
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      } catch (e) {
        console.warn('Lá»—i khi lÆ°u localStorage', e);
      }
    }
    function loadFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const data = JSON.parse(raw);
          if (data.students) Object.assign(students, data.students);
          if (data.totalStudents) totalStudents = data.totalStudents;
          if (data.dailyData) Object.assign(dailyData, data.dailyData);
          document.getElementById('input-total').value = totalStudents;
          document.getElementById('stat-total').textContent = totalStudents;
        }
      } catch (e) {
        console.warn('Lá»—i khi Ä‘á»c localStorage', e);
      }
    }

    const students = {};
    let totalStudents = 30;
    let dailyData = {}; // LÆ°u dá»¯ liá»‡u theo ngÃ y: {date: {students: {...}}}
    const ratingLabels = [
      'Ká»¹ nÄƒng giao tiáº¿p',
      'Kháº£ nÄƒng há»c táº­p',
      'SÃ¡ng táº¡o & TÆ°á»Ÿng tÆ°á»£ng',
      'Ká»· luáº­t & TuÃ¢n thá»§',
      'TÆ°Æ¡ng tÃ¡c xÃ£ há»™i',
      'Ká»¹ nÄƒng váº­n Ä‘á»™ng',
      'Tá»± chÄƒm sÃ³c báº£n thÃ¢n',
      'Cáº£m xÃºc & ThÃ¡i Ä‘á»™',
      'Táº­p trung & ChÃº Ã½',
      'GiÃºp Ä‘á»¡ báº¡n bÃ¨'
    ];

    document.getElementById('input-date').valueAsDate = new Date();

    function updateAttendancePreview() {
      const attendance = document.getElementById('input-attendance').value;
      const number = parseInt(document.getElementById('input-number').value);
      const card = document.getElementById(`student-${number}`);

      if (card && attendance) {
        card.classList.remove('present', 'absent', 'empty');
        card.classList.add(attendance);
      }
    }

    function initStudentList() {
      const list = document.getElementById('student-list');
      list.innerHTML = '';

      for (let i = 1; i <= totalStudents; i++) {
        const card = document.createElement('div');
        card.id = `student-${i}`;
        card.onclick = () => selectStudent(i);

        const student = students[i];
        if (student) {
          // Máº·c Ä‘á»‹nh lÃ  xanh (cÃ³ máº·t), chá»‰ Ä‘á»•i Ä‘á» khi váº¯ng
          card.className = student.attendance === 'absent' ? 'student-card absent' : 'student-card';

          let badgeHTML = '';
          if (student.attendance === 'absent') {
            badgeHTML = '<div class="attendance-badge">âŒ</div>';
          }

          let ratingHTML = '';
          if (student.ratings) {
            const avg = (student.ratings.reduce((a, b) => a + b, 0) / 10).toFixed(1);
            ratingHTML = `<div class="rating-badge">TB: ${avg}</div>`;
          }

          card.innerHTML = `
            <div class="student-number">${i}</div>
            <div class="student-name">${student.name}</div>
            ${ratingHTML}
            ${badgeHTML}
          `;
        } else {
          card.className = 'student-card empty';
          card.innerHTML = `
            <div class="student-number">${i}</div>
            <div class="student-name">ChÆ°a cÃ³</div>
          `;
        }

        list.appendChild(card);
      }

      updateStats();
      updateOutputTable();
    }

    function updateTotalStudents() {
      const input = document.getElementById('input-total');
      const newTotal = parseInt(input.value);

      if (newTotal < 1 || newTotal > 60) {
        alert('Sá»‘ há»c sinh pháº£i tá»« 1 Ä‘áº¿n 60!');
        return;
      }

      totalStudents = newTotal;
      document.getElementById('stat-total').textContent = totalStudents;
      saveToStorage();
      initStudentList();
    }

    function saveBasicInfo() {
      const number = parseInt(document.getElementById('input-number').value);
      const name = document.getElementById('input-name').value.trim();
      const attendance = document.getElementById('input-attendance').value;
      const date = document.getElementById('input-date').value;

      if (number < 1 || number > totalStudents) {
        alert(`Sá»‘ thá»© tá»± pháº£i tá»« 1 Ä‘áº¿n ${totalStudents}!`);
        return;
      }

      if (!name) {
        alert('Vui lÃ²ng nháº­p tÃªn há»c sinh!');
        return;
      }

      if (!attendance) {
        alert('Vui lÃ²ng chá»n Ä‘iá»ƒm danh!');
        return;
      }

      if (!students[number]) students[number] = {};
      students[number].name = name;
      students[number].attendance = attendance;

      // LÆ°u dá»¯ liá»‡u theo ngÃ y
      if (!dailyData[date]) dailyData[date] = {};
      if (!dailyData[date][number]) dailyData[date][number] = {};
      dailyData[date][number].name = name;
      dailyData[date][number].attendance = attendance;

      saveToStorage();
      initStudentList();

      if (number < totalStudents) {
        document.getElementById('input-number').value = number + 1;
        document.getElementById('input-name').value = '';
        document.getElementById('input-name').focus();
      }
    }

    function saveRatings() {
      const number = parseInt(document.getElementById('input-number').value);
      const date = document.getElementById('input-date').value;

      if (!students[number] || !students[number].name) {
        alert('Vui lÃ²ng lÆ°u thÃ´ng tin cÆ¡ báº£n trÆ°á»›c!');
        return;
      }

      const personality = document.getElementById('input-personality').value.trim();
      const ratings = [];

      for (let i = 1; i <= 10; i++) {
        const value = parseInt(document.getElementById(`rating-${i}`).value);
        if (value < 1 || value > 10) {
          alert(`Äiá»ƒm má»¥c ${i} pháº£i tá»« 1 Ä‘áº¿n 10!`);
          return;
        }
        ratings.push(value);
      }

      students[number].personality = personality || 'ChÆ°a mÃ´ táº£';
      students[number].ratings = ratings;

      // LÆ°u Ä‘Ã¡nh giÃ¡ theo ngÃ y
      if (!dailyData[date]) dailyData[date] = {};
      if (!dailyData[date][number]) dailyData[date][number] = {};
      dailyData[date][number].personality = personality || 'ChÆ°a mÃ´ táº£';
      dailyData[date][number].ratings = ratings;

      saveToStorage();
      initStudentList();
      alert('âœ… ÄÃ£ lÆ°u Ä‘Ã¡nh giÃ¡ thÃ nh cÃ´ng!');
    }

    function selectStudent(number) {
      document.getElementById('input-number').value = number;

      const student = students[number];
      if (student) {
        document.getElementById('input-name').value = student.name || '';
        document.getElementById('input-attendance').value = student.attendance || '';
        document.getElementById('input-personality').value = student.personality || '';

        if (student.ratings) {
          for (let i = 0; i < 10; i++) {
            document.getElementById(`rating-${i + 1}`).value = student.ratings[i];
          }
        } else {
          for (let i = 1; i <= 10; i++) {
            document.getElementById(`rating-${i}`).value = 5;
          }
        }
      } else {
        document.getElementById('input-name').value = '';
        document.getElementById('input-attendance').value = '';
        document.getElementById('input-personality').value = '';
        for (let i = 1; i <= 10; i++) {
          document.getElementById(`rating-${i}`).value = 5;
        }
      }

      document.getElementById('input-name').focus();
      window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function clearStudent() {
      const number = parseInt(document.getElementById('input-number').value);
      delete students[number];
      document.getElementById('input-name').value = '';
      document.getElementById('input-personality').value = '';
      saveToStorage();
      initStudentList();
    }

    function markAllPresent() {
      for (let i = 1; i <= totalStudents; i++) {
        if (students[i]) {
          students[i].attendance = 'present';
        }
      }
      saveToStorage();
      initStudentList();
    }

    function clearAllAttendance() {
      if (confirm('Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a táº¥t cáº£ dá»¯ liá»‡u?')) {
        for (let key in students) {
          delete students[key];
        }
        dailyData = {};
        saveToStorage();
        initStudentList();
      }
    }

    function updateStats() {
      let present = 0, absent = 0, rated = 0;

      for (let key in students) {
        if (students[key].attendance === 'absent') {
          absent++;
        } else if (students[key].name) {
          // Náº¿u cÃ³ tÃªn vÃ  khÃ´ng váº¯ng thÃ¬ tÃ­nh lÃ  cÃ³ máº·t
          present++;
        }
        if (students[key].ratings) rated++;
      }

      document.getElementById('stat-present').textContent = present;
      document.getElementById('stat-absent').textContent = absent;
      document.getElementById('stat-rated').textContent = rated;
    }

    function updateOutputTable() {
      const output = document.getElementById('output-table');
      const sortedKeys = Object.keys(students).sort((a, b) => parseInt(a) - parseInt(b));

      if (sortedKeys.length === 0) {
        output.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:40px">ChÆ°a cÃ³ dá»¯ liá»‡u</div>';
        return;
      }

      let html = '<table class="output-table"><thead><tr>';
      html += '<th>STT</th><th>Há» vÃ  TÃªn</th><th>Äiá»ƒm danh</th><th>TÃ­nh cÃ¡ch</th>';

      for (let i = 1; i <= 10; i++) {
        html += `<th>M${i}</th>`;
      }

      html += '<th>TB</th></tr></thead><tbody>';

      sortedKeys.forEach(key => {
        const s = students[key];
        html += '<tr>';
        html += `<td style="text-align:center;font-weight:700;color:var(--primary)">${key}</td>`;
        html += `<td><strong>${s.name}</strong></td>`;

        // Hiá»ƒn thá»‹ Ä‘iá»ƒm danh: Váº¯ng máº·t hoáº·c CÃ³ máº·t
        const attendanceText = s.attendance === 'absent' ? 'âŒ Váº¯ng máº·t' : 'âœ… CÃ³ máº·t';
        const attendanceColor = s.attendance === 'absent' ? '#ef4444' : '#10b981';
        html += `<td style="text-align:center;font-weight:700;color:${attendanceColor}">${attendanceText}</td>`;

        html += `<td>${s.personality || '-'}</td>`;

        if (s.ratings) {
          s.ratings.forEach(r => {
            const color = r >= 8 ? '#10b981' : r >= 5 ? '#f59e0b' : '#ef4444';
            html += `<td style="text-align:center;font-weight:700;color:${color}">${r}</td>`;
          });
          const avg = (s.ratings.reduce((a, b) => a + b, 0) / 10).toFixed(1);
          html += `<td style="text-align:center;font-weight:700;background:#eef2ff;color:var(--primary)">${avg}</td>`;
        } else {
          for (let i = 0; i < 11; i++) html += '<td style="text-align:center">-</td>';
        }

        html += '</tr>';
      });

      html += '</tbody></table>';
      output.innerHTML = html;
    }

    function importFromFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const lines = text.split('\n');
          let imported = 0;

          for (let line of lines) {
            line = line.trim();
            if (!line || line.startsWith('=') || line.startsWith('-')) continue;

            if (line.startsWith('STT:')) {
              const sttMatch = line.match(/STT:\s*(\d+)/);
              if (!sttMatch) continue;

              const number = parseInt(sttMatch[1]);
              if (number < 1 || number > 60) continue;

              if (!students[number]) students[number] = {};

              let idx = lines.indexOf(line);

              for (let i = idx + 1; i < lines.length && i < idx + 20; i++) {
                const l = lines[i].trim();

                if (l.startsWith('Há» vÃ  tÃªn:')) {
                  students[number].name = l.replace('Há» vÃ  tÃªn:', '').trim();
                }
                else if (l.startsWith('TÃ­nh cÃ¡ch:')) {
                  students[number].personality = l.replace('TÃ­nh cÃ¡ch:', '').trim();
                }
                else if (l.match(/^\d+\.\s+.+:\s+(\d+)\/10$/)) {
                  if (!students[number].ratings) students[number].ratings = [];
                  const ratingMatch = l.match(/:\s+(\d+)\/10$/);
                  if (ratingMatch) {
                    students[number].ratings.push(parseInt(ratingMatch[1]));
                  }
                }
                else if (l.startsWith('STT:')) {
                  break;
                }
              }

              if (students[number].name) {
                students[number].attendance = 'present';
                imported++;
              }
            }
          }

          if (imported > 0) {
            alert(`âœ… ÄÃ£ nháº­p thÃ nh cÃ´ng ${imported} há»c sinh tá»« file!`);
            saveToStorage();
            initStudentList();
          } else {
            alert('âŒ KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u há»£p lá»‡ trong file!');
          }

        } catch (error) {
          alert('âŒ Lá»—i khi Ä‘á»c file: ' + error.message);
        }

        event.target.value = '';
      };

      reader.readAsText(file, 'UTF-8');
    }

    function exportToFile() {
      if (Object.keys(students).length === 0 && Object.keys(dailyData).length === 0) {
        alert('ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!');
        return;
      }

      const currentDate = document.getElementById('input-date').value;
      let content = 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n';
      content += 'â•‘     Báº¢NG ÄÃNH GIÃ Há»ŒC SINH MáºªU GIÃO - BÃO CÃO CHI TIáº¾T      â•‘\n';
      content += 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
      content += 'ğŸ“… NgÃ y xuáº¥t: ' + new Date().toLocaleString('vi-VN') + '\n';
      content += 'ğŸ“ Thang Ä‘iá»ƒm: 1-10 (1: Yáº¿u â†’ 10: Xuáº¥t sáº¯c)\n\n';

      content += 'ğŸ“‹ 10 Má»¥c Ä‘Ã¡nh giÃ¡:\n';
      ratingLabels.forEach((label, i) => {
        content += `   ${i + 1}. ${label}\n`;
      });
      content += '\n' + 'â•'.repeat(80) + '\n\n';

      // PHáº¦N 1: Dá»® LIá»†U THEO NGÃ€Y
      if (Object.keys(dailyData).length > 0) {
        content += 'ï¿½ï¿½ï¿½ PHáº¦N I: Dá»® LIá»†U THEO NGÃ€Y\n';
        content += 'â•'.repeat(80) + '\n\n';

        const sortedDates = Object.keys(dailyData).sort();

        sortedDates.forEach(date => {
          content += `\nğŸ“… NGÃ€Y: ${date}\n`;
          content += 'â”€'.repeat(80) + '\n';

          const dayStudents = dailyData[date];
          const sortedKeys = Object.keys(dayStudents).sort((a, b) => parseInt(a) - parseInt(b));

          let presentCount = 0, absentCount = 0;

          sortedKeys.forEach(key => {
            const s = dayStudents[key];

            content += `\nğŸ“Œ STT: ${key}\n`;
            content += `   ğŸ‘¤ Há» vÃ  tÃªn: ${s.name}\n`;

            if (s.attendance === 'absent') {
              content += `   ğŸ“Š Äiá»ƒm danh: âŒ Váº®NG Máº¶T\n`;
              absentCount++;
            } else {
              content += `   ğŸ“Š Äiá»ƒm danh: âœ… CÃ“ Máº¶T\n`;
              presentCount++;
            }

            if (s.personality) {
              content += `   ğŸ’­ TÃ­nh cÃ¡ch: ${s.personality}\n`;
            }

            if (s.ratings) {
              content += `   â­ ÄÃ¡nh giÃ¡ chi tiáº¿t:\n`;
              s.ratings.forEach((rating, i) => {
                const stars = 'â˜…'.repeat(Math.round(rating));
                content += `      ${i + 1}. ${ratingLabels[i]}: ${rating}/10 ${stars}\n`;
              });
              const avg = (s.ratings.reduce((a, b) => a + b, 0) / 10).toFixed(1);
              content += `   ğŸ† Äiá»ƒm trung bÃ¬nh: ${avg}/10\n`;
            }
          });

          content += `\nğŸ“Š THá»NG KÃŠ NGÃ€Y ${date}:\n`;
          content += `   â€¢ Tá»•ng há»c sinh: ${sortedKeys.length}\n`;
          content += `   â€¢ CÃ³ máº·t: ${presentCount} há»c sinh âœ…\n`;
          content += `   â€¢ Váº¯ng: ${absentCount} há»c sinh âŒ\n`;
          content += `   â€¢ Tá»· lá»‡ cÃ³ máº·t: ${((presentCount / sortedKeys.length) * 100).toFixed(1)}%\n`;
          content += '\n' + 'â”€'.repeat(80) + '\n';
        });
      }

      // PHáº¦N 2: Tá»”NG Káº¾T THÃNG
      content += '\n\n';
      content += 'ğŸ“Š PHáº¦N II: Tá»”NG Káº¾T THEO THÃNG\n';
      content += 'â•'.repeat(80) + '\n\n';

      const monthlyStats = {};

      Object.keys(dailyData).forEach(date => {
        const month = date.substring(0, 7); // YYYY-MM
        if (!monthlyStats[month]) {
          monthlyStats[month] = {
            totalDays: 0,
            studentAttendance: {},
            totalPresent: 0,
            totalAbsent: 0
          };
        }

        monthlyStats[month].totalDays++;

        Object.keys(dailyData[date]).forEach(stuNum => {
          const s = dailyData[date][stuNum];
          if (!monthlyStats[month].studentAttendance[stuNum]) {
            monthlyStats[month].studentAttendance[stuNum] = {
              name: s.name,
              present: 0,
              absent: 0,
              ratings: []
            };
          }

          if (s.attendance === 'absent') {
            monthlyStats[month].studentAttendance[stuNum].absent++;
            monthlyStats[month].totalAbsent++;
          } else {
            monthlyStats[month].studentAttendance[stuNum].present++;
            monthlyStats[month].totalPresent++;
          }

          if (s.ratings) {
            monthlyStats[month].studentAttendance[stuNum].ratings.push(s.ratings);
          }
        });
      });

      Object.keys(monthlyStats).sort().forEach(month => {
        const stats = monthlyStats[month];
        const [year, monthNum] = month.split('-');

        content += `\nğŸ“… THÃNG ${monthNum}/${year}\n`;
        content += 'â”€'.repeat(80) + '\n';
        content += `ğŸ“† Tá»•ng sá»‘ ngÃ y cÃ³ dá»¯ liá»‡u: ${stats.totalDays} ngÃ y\n`;
        content += `ğŸ‘¥ Tá»•ng lÆ°á»£t cÃ³ máº·t: ${stats.totalPresent}\n`;
        content += `âŒ Tá»•ng lÆ°á»£t váº¯ng: ${stats.totalAbsent}\n`;
        content += `ğŸ“Š Tá»· lá»‡ cÃ³ máº·t: ${((stats.totalPresent / (stats.totalPresent + stats.totalAbsent)) * 100).toFixed(1)}%\n\n`;

        content += `ğŸ“‹ CHI TIáº¾T Tá»ªNG Há»ŒC SINH:\n\n`;

        const sortedStudents = Object.keys(stats.studentAttendance).sort((a, b) => parseInt(a) - parseInt(b));

        sortedStudents.forEach(stuNum => {
          const stuData = stats.studentAttendance[stuNum];
          const attendanceRate = ((stuData.present / (stuData.present + stuData.absent)) * 100).toFixed(1);

          content += `   ${stuNum}. ${stuData.name}\n`;
          content += `      â€¢ CÃ³ máº·t: ${stuData.present} ngÃ y âœ…\n`;
          content += `      â€¢ Váº¯ng: ${stuData.absent} ngÃ y âŒ\n`;
          content += `      â€¢ Tá»· lá»‡ chuyÃªn cáº§n: ${attendanceRate}%\n`;

          if (stuData.ratings.length > 0) {
            const avgRatings = [];
            for (let i = 0; i < 10; i++) {
              const sum = stuData.ratings.reduce((acc, r) => acc + r[i], 0);
              avgRatings.push((sum / stuData.ratings.length).toFixed(1));
            }
            const totalAvg = (avgRatings.reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / 10).toFixed(1);
            content += `      â€¢ Äiá»ƒm trung bÃ¬nh thÃ¡ng: ${totalAvg}/10 â­\n`;
          }
          content += '\n';
        });

        content += 'â”€'.repeat(80) + '\n';
      });

      content += '\n' + 'â•'.repeat(80) + '\n';
      content += '                    *** Háº¾T BÃO CÃO ***\n';
      content += 'â•'.repeat(80) + '\n';

      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'kindergarten-report-' + new Date().toISOString().slice(0,10) + '.txt';
      a.click();
      URL.revokeObjectURL(url);

      alert('âœ… ÄÃ£ xuáº¥t bÃ¡o cÃ¡o Ä‘áº§y Ä‘á»§ theo ngÃ y vÃ  thÃ¡ng!');
    }

    function exportToExcel(type) {
      if (Object.keys(dailyData).length === 0 && Object.keys(students).length === 0) {
        alert('ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t!');
        return;
      }

      let csvContent = '';
      const currentDate = document.getElementById('input-date').value;

      if (type === 'day') {
        // XUáº¤T THEO NGÃ€Y
        csvContent = 'BÃO CÃO THEO NGÃ€Y - ' + currentDate + '\n\n';
        csvContent += 'STT,Há» vÃ  TÃªn,Äiá»ƒm Danh,TÃ­nh CÃ¡ch,';

        for (let i = 1; i <= 10; i++) {
          csvContent += `Má»¥c ${i},`;
        }
        csvContent += 'Äiá»ƒm TB\n';

        // Láº¥y dá»¯ liá»‡u ngÃ y hiá»‡n táº¡i hoáº·c dá»¯ liá»‡u Ä‘ang hiá»ƒn thá»‹
        const dataToExport = dailyData[currentDate] || students;
        const sortedKeys = Object.keys(dataToExport).sort((a, b) => parseInt(a) - parseInt(b));

        sortedKeys.forEach(key => {
          const s = dataToExport[key];
          const attendanceText = s.attendance === 'absent' ? 'Váº¯ng' : 'CÃ³ máº·t';

          csvContent += `${key},"${s.name}",${attendanceText},"${s.personality || ''}"`;

          if (s.ratings) {
            s.ratings.forEach(r => {
              csvContent += `,${r}`;
            });
            const avg = (s.ratings.reduce((a, b) => a + b, 0) / 10).toFixed(1);
            csvContent += `,${avg}`;
          } else {
            for (let i = 0; i < 11; i++) csvContent += ',';
          }
          csvContent += '\n';
        });

        csvContent += `\nThá»‘ng kÃª ngÃ y ${currentDate}\n`;
        const present = sortedKeys.filter(k => dataToExport[k].attendance !== 'absent').length;
        const absent = sortedKeys.filter(k => dataToExport[k].attendance === 'absent').length;
        csvContent += `Tá»•ng sá»‘ há»c sinh,${sortedKeys.length}\n`;
        csvContent += `CÃ³ máº·t,${present}\n`;
        csvContent += `Váº¯ng,${absent}\n`;
        csvContent += `Tá»· lá»‡ cÃ³ máº·t,${((present / sortedKeys.length) * 100).toFixed(1)}%\n`;

      } else if (type === 'week') {
        // XUáº¤T THEO TUáº¦N
        const dates = Object.keys(dailyData).sort();
        if (dates.length === 0) {
          alert('ChÆ°a cÃ³ dá»¯ liá»‡u theo ngÃ y Ä‘á»ƒ xuáº¥t theo tuáº§n!');
          return;
        }

        // Láº¥y 7 ngÃ y gáº§n nháº¥t
        const weekDates = dates.slice(-7);

        csvContent = 'BÃO CÃO THEO TUáº¦N (' + weekDates[0] + ' Ä‘áº¿n ' + weekDates[weekDates.length - 1] + ')\n\n';
        csvContent += 'STT,Há» vÃ  TÃªn';

        weekDates.forEach(date => {
          csvContent += `,${date}`;
        });
        csvContent += ',Tá»•ng CÃ³ Máº·t,Tá»•ng Váº¯ng,Tá»· Lá»‡ (%)\n';

        // Thu tháº­p táº¥t cáº£ há»c sinh trong tuáº§n
        const allStudents = {};
        weekDates.forEach(date => {
          Object.keys(dailyData[date]).forEach(stuNum => {
            if (!allStudents[stuNum]) {
              allStudents[stuNum] = {
                name: dailyData[date][stuNum].name,
                attendance: {}
              };
            }
            allStudents[stuNum].attendance[date] = dailyData[date][stuNum].attendance;
          });
        });

        const sortedStudents = Object.keys(allStudents).sort((a, b) => parseInt(a) - parseInt(b));

        sortedStudents.forEach(stuNum => {
          const stu = allStudents[stuNum];
          csvContent += `${stuNum},"${stu.name}"`;

          let presentCount = 0, absentCount = 0;

          weekDates.forEach(date => {
            if (stu.attendance[date]) {
              const status = stu.attendance[date] === 'absent' ? 'Váº¯ng' : 'CÃ³ máº·t';
              csvContent += `,${status}`;
              if (stu.attendance[date] === 'absent') absentCount++;
              else presentCount++;
            } else {
              csvContent += ',';
            }
          });

          const total = presentCount + absentCount;
          const rate = total > 0 ? ((presentCount / total) * 100).toFixed(1) : 0;
          csvContent += `,${presentCount},${absentCount},${rate}%\n`;
        });

        csvContent += '\nThá»‘ng kÃª tuáº§n\n';
        weekDates.forEach(date => {
          const dayData = dailyData[date];
          const present = Object.keys(dayData).filter(k => dayData[k].attendance !== 'absent').length;
          const absent = Object.keys(dayData).filter(k => dayData[k].attendance === 'absent').length;
          csvContent += `${date},CÃ³ máº·t: ${present} - Váº¯ng: ${absent}\n`;
        });

      } else if (type === 'month') {
        // XUáº¤T THEO THÃNG
        const dates = Object.keys(dailyData).sort();
        if (dates.length === 0) {
          alert('ChÆ°a cÃ³ dá»¯ liá»‡u theo ngÃ y Ä‘á»ƒ xuáº¥t theo thÃ¡ng!');
          return;
        }

        // NhÃ³m theo thÃ¡ng
        const months = {};
        dates.forEach(date => {
          const month = date.substring(0, 7);
          if (!months[month]) months[month] = [];
          months[month].push(date);
        });

        const sortedMonths = Object.keys(months).sort();
        const latestMonth = sortedMonths[sortedMonths.length - 1];
        const monthDates = months[latestMonth];

        csvContent = 'BÃO CÃO THEO THÃNG ' + latestMonth + '\n\n';
        csvContent += 'STT,Há» vÃ  TÃªn,Sá»‘ NgÃ y CÃ³ Máº·t,Sá»‘ NgÃ y Váº¯ng,Tá»•ng NgÃ y,Tá»· Lá»‡ ChuyÃªn Cáº§n (%),Äiá»ƒm TB ThÃ¡ng\n';

        const monthStudents = {};
        monthDates.forEach(date => {
          Object.keys(dailyData[date]).forEach(stuNum => {
            if (!monthStudents[stuNum]) {
              monthStudents[stuNum] = {
                name: dailyData[date][stuNum].name,
                present: 0,
                absent: 0,
                ratings: []
              };
            }

            if (dailyData[date][stuNum].attendance === 'absent') {
              monthStudents[stuNum].absent++;
            } else {
              monthStudents[stuNum].present++;
            }

            if (dailyData[date][stuNum].ratings) {
              monthStudents[stuNum].ratings.push(dailyData[date][stuNum].ratings);
            }
          });
        });

        const sortedMonthStudents = Object.keys(monthStudents).sort((a, b) => parseInt(a) - parseInt(b));

        sortedMonthStudents.forEach(stuNum => {
          const stu = monthStudents[stuNum];
          const total = stu.present + stu.absent;
          const rate = ((stu.present / total) * 100).toFixed(1);

          let avgScore = '';
          if (stu.ratings.length > 0) {
            const totalAvg = stu.ratings.map(r => r.reduce((a, b) => a + b, 0) / 10);
            avgScore = (totalAvg.reduce((a, b) => a + b, 0) / totalAvg.length).toFixed(1);
          }

          csvContent += `${stuNum},"${stu.name}",${stu.present},${stu.absent},${total},${rate}%,${avgScore}\n`;
        });

        csvContent += '\nTá»•ng há»£p thÃ¡ng ' + latestMonth + '\n';
        csvContent += `Sá»‘ ngÃ y cÃ³ dá»¯ liá»‡u,${monthDates.length}\n`;

        let totalPresent = 0, totalAbsent = 0;
        Object.values(monthStudents).forEach(stu => {
          totalPresent += stu.present;
          totalAbsent += stu.absent;
        });

        csvContent += `Tá»•ng lÆ°á»£t cÃ³ máº·t,${totalPresent}\n`;
        csvContent += `Tá»•ng lÆ°á»£t váº¯ng,${totalAbsent}\n`;
        csvContent += `Tá»· lá»‡ cÃ³ máº·t trung bÃ¬nh,${((totalPresent / (totalPresent + totalAbsent)) * 100).toFixed(1)}%\n`;

        csvContent += '\n\nChi tiáº¿t 10 má»¥c Ä‘Ã¡nh giÃ¡ trung bÃ¬nh thÃ¡ng\n';
        csvContent += 'STT,Há» vÃ  TÃªn';
        for (let i = 1; i <= 10; i++) {
          csvContent += `,${ratingLabels[i - 1]}`;
        }
        csvContent += '\n';

        sortedMonthStudents.forEach(stuNum => {
          const stu = monthStudents[stuNum];
          csvContent += `${stuNum},"${stu.name}"`;

          if (stu.ratings.length > 0) {
            for (let i = 0; i < 10; i++) {
              const sum = stu.ratings.reduce((acc, r) => acc + r[i], 0);
              const avg = (sum / stu.ratings.length).toFixed(1);
              csvContent += `,${avg}`;
            }
          } else {
            for (let i = 0; i < 10; i++) csvContent += ',';
          }
          csvContent += '\n';
        });
      }

      // ThÃªm BOM cho UTF-8
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const typeNames = {
        'day': 'ngay',
        'week': 'tuan',
        'month': 'thang'
      };
      a.download = `kindergarten-${typeNames[type]}-${new Date().toISOString().slice(0, 10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);

      alert(`âœ… ÄÃ£ xuáº¥t bÃ¡o cÃ¡o Excel theo ${type === 'day' ? 'ngÃ y' : type === 'week' ? 'tuáº§n' : 'thÃ¡ng'}!`);
    }

    // load saved data first, then init list
    loadFromStorage();
    initStudentList();

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(()=>{});
    }
  </script>
</body>
</html>
